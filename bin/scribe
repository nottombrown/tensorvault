#! /bin/python3
import logging
import subprocess
import sys
import time

from tf_scribe.metadata import write_experiment_metadata

logger = logging.getLogger('tf-scribe')

def run():
    """
    Write the metadata for an experiment to a the root of the dir where its logs will be written.
    Then execute the experiment.
    """
    bad_usage_message = "Bad input. Correct usage is `scribe <optional_experiment_dir> -- python entrypoint.py`"
    if len(sys.argv) < 3:
        logger.error(bad_usage_message)
        return 1

    if sys.argv[1] == '--':
        experiment_dir = "/tmp/scribe_experiments/experiment-%s" % time.strftime("%Y-%m-%d--%H-%M-%S")
        entrypoint = sys.argv[2:]
    elif sys.argv[2] == '--':
        experiment_dir = sys.argv[1]
        entrypoint = sys.argv[3:]
    else:
        logger.error(bad_usage_message)
        return 1

    write_experiment_metadata(entrypoint, experiment_dir)
    return subprocess.check_call(entrypoint)

if __name__ == '__main__':
    run()
